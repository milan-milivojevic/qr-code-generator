<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BITZER - QR Code Generator</title>
    <link rel="shortcut icon" th:href="@{bitzer_tab.ico}" type="image/x-icon"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{css/main.css(v=${#dates.createNow().getTime()})}" />
    <script th:src="@{js/commons.js}"></script>
</head>
<body>

<div id="app">
    <h1 data-translate-key="1">QR CODE GENERATOR</h1>
    <div id="search-create-container">
        <input type="text" id="search-input" data-translate-key="2" placeholder="Search"/>
        <button id="create-button" data-translate-key="3" onclick="displayCreateModal()">Create New QR Code</button>
    </div>
    <div id="qr-container"></div>
    <div class="pagination">
        <button id="prevBtn" data-translate-key="13" onclick="prevPage()" disabled>Previous</button>
        <span id="pageInfo"></span>
        <button id="nextBtn" data-translate-key="15" onclick="nextPage()">Next</button>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // allQRCodes (master list), and qrCodes (filtered list).
    let allQRCodes = [];
    let qrCodes = [];
    let serverUrl = "";

    try {
        allQRCodes = [[${qrCodes}]];  // Load from backend
        serverUrl = [[${serverUrl}]];
    } catch (e) {
        cLog("Model loading error ", e);
    }
    /*]]>*/

    if (allQRCodes !== null && allQRCodes.length > 0) {
        cLog("QR Codes loaded. " + MESSAGE);
        console.log(allQRCodes);

        // Reverse for the newest first
        allQRCodes.reverse();

        // Initially, display all codes
        qrCodes = allQRCodes.slice();  // Make a copy
        getCurrentUser(); // sets language and privileges
        renderQRCodes();
        doTranslate('app');
    } else {
        document.getElementById('app').innerHTML = `Error: QR Codes could not be loaded.`;
        cLog("ERROR: QR Codes not loaded.");
    }

    function searchQRCodes() {
        const term = document.getElementById('search-input').value.trim().toLowerCase();
        console.log("TERM:", term);

        if (!term) {
            // No search => restore the full list
            qrCodes = allQRCodes.slice();
        } else {
            qrCodes = allQRCodes.filter(qr => {
                // 1) Start with the qr.name
                let combinedText = (qr.name || "").toLowerCase();

                // 2) Append all attributeValues
                if (Array.isArray(qr.attributeValues)) {
                    qr.attributeValues.forEach(attr => {
                        // Merge each attribute value into the combinedText
                        if (attr.value) {
                            combinedText += " " + attr.value.toLowerCase();
                        }
                    });
                }

                // 3) Return true if combinedText has the search term
                return combinedText.includes(term);
            });
        }

        currentPage = 1;
        renderQRCodes();
        doTranslate('app');
    }

    function renderQRCodes() {
        const container = document.getElementById("qr-container");
        container.innerHTML = "";  // Clear previous content

        const startIndex = (currentPage - 1) * itemsPerPage; // these come from commons.js
        const endIndex = startIndex + itemsPerPage;

        // If qrCodes is empty or has fewer items, handle it gracefully
        const paginatedItems = qrCodes.slice(startIndex, endIndex);

        paginatedItems.forEach(qrCode => {
            const qrCodeId = qrCode.id;
            const qrCodeName = qrCode.name;
            const createDate = qrCode.createDate;
            const createDateOnly = new Date(createDate).toLocaleDateString("de-DE");

            // Extract attributes
            const campaignName = qrCode.attributeValues.find(attr => attr.attributeName === "campaign_name")?.value || "Not Found";
            const campaignMedium = qrCode.attributeValues.find(attr => attr.attributeName === "campaign_medium")?.value || "Not Found";
            const campaignSubject = qrCode.attributeValues.find(attr => attr.attributeName === "campaign_subject")?.value || "Not Found";
            const urlCode = qrCode.attributeValues.find(attr => attr.attributeName === "url_code")?.value || "Not Found";
            const urlEncoded = qrCode.attributeValues.find(attr => attr.attributeName === "url_encoded")?.value || "Not Found";
            const trackingUrl = qrCode.attributeValues.find(attr => attr.attributeName === "tracking_url")?.value || "Not Found";
            const language = qrCode.attributeValues.find(attr => attr.attributeName === "language")?.value || "Not Found";
            const additionalInfo = qrCode.attributeValues.find(attr => attr.attributeName === "additional_information")?.value || "Not Found";
            const publishedValue = qrCode.attributeValues.find(attr => attr.attributeName === "published")?.value || "Not Found";

            let published = "";
            if (publishedValue === "true") {
                published = "checked";
            }

            // Build the HTML
            const qrDiv = document.createElement("div");
            qrDiv.classList.add("qr-code-container");
            qrDiv.dataset.qrid = qrCodeId;

            qrDiv.innerHTML = `
                <div class="qr-lay-1">
                    <div class="qr-lay-1-1">
                        <div class="qr-lay-1-1-1">
                            <div class="qr-lay-field">
                                <b data-translate-key="4" >Campaign Name</b><br>
                                ${campaignName}
                            </div>
                            <div class="qr-lay-field">
                                <b data-translate-key="5">Campaign Medium</b><br>
                                ${campaignMedium}
                            </div>
                        </div>
                        <div class="qr-lay-1-1-2">
                            <div class="qr-lay-field">
                                <b data-translate-key="7">URL Code</b><br>
                                ${urlCode}
                            </div>
                            <div class="qr-lay-field">
                                <b data-translate-key="8">Additional Information</b><br>
                                ${additionalInfo}
                            </div>
                        </div>
                    </div>
                    <div class="qr-lay-1-2">
                        <div class="qr-lay-field">
                            <b data-translate-key="6">Language</b><br>
                            ${language}
                        </div>
                    </div>
                    <div class="qr-lay-1-3">
                        <div class="qr-lay-field">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${urlEncoded}" alt="QR Code"/>
                        </div>
                    </div>
                </div>
                <div class="qr-lay-2">
                    <div class="qr-lay-2-1">
                        <div class="qr-lay-2-1-1">
                            <div class="qr-lay-2-1-1-1 qr-lay-field">
                                <b data-translate-key="9">URL Encoded</b><br>
                                <input type="text" placeholder="${urlEncoded}" readonly>
                            </div>
                            <div class="qr-lay-2-1-1-2">
                                <div class="qr-lay-2-1-1-2-1">
                                    <div class="qr-lay-field">
                                        <b data-translate-key="10">Created</b><br>
                                        ${createDateOnly}
                                    </div>
                                </div>
                                <div class="qr-lay-2-1-1-2-2">
                                    <div class="qr-lay-field">
                                        <b data-translate-key="11">Published</b>
                                        <label class="switch">
                                            <input type="checkbox" ${published}>
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="qr-lay-2-1-2 qr-lay-field">
                            <b data-translate-key="12">Tracking URL</b><br>
                            <input type="text" placeholder="${trackingUrl}" readonly>
                        </div>
                    </div>
                    <div class="qr-lay-2-2">
                        <i class="fas fa-pencil-alt icon-container"
                           onclick="displayEditModal('${qrCodeId}', '${campaignName}', '${campaignMedium}', '${language}', '${trackingUrl}', '${additionalInfo}')"></i><br>
                        <i class="fas fa-trash icon-container" onclick="displayDeleteModal(${qrCodeId})"></i><br>
                        <i class="fas fa-download icon-container" onclick="displayDownloadModal('${qrCodeId}','${campaignName}')"></i>
                    </div>
                </div>
            `;

            container.appendChild(qrDiv);

            // for list view
            // const qrDiv2 = document.createElement("div");
            // qrDiv2.classList.add("qr-code-container");
            // qrDiv2.dataset.qrid = qrCodeId;
            // qrDiv2.innerHTML = `
            // <div class="list-qrcode-item">
            //     <span>${urlCode}</span>
            //     <span>${campaignSubject}</span>
            //     <span>${campaignName}</span>
            //     <span>${campaignMedium}</span>
            //     <span>${createDate}</span>
            //     <span><i class="fas fa-pencil-alt icon-container"
            //                onclick="displayEditModal('${qrCodeId}', '${campaignName}', '${campaignMedium}', '${language}', '${trackingUrl}', '${additionalInfo}')"></i></span>
            //     <span><i class="fas fa-trash icon-container" onclick="displayDeleteModal(${qrCodeId})"></i></span>
            //     <span><i class="fas fa-download icon-container" onclick="displayDownloadModal('${qrCodeId}','${campaignName}')"></i></span>
            // </div>
            // `;
            // container.appendChild(qrDiv2);
        });

        updatePaginationButtons();
    }

    function updatePaginationButtons() {
        document.getElementById("prevBtn").disabled = (currentPage === 1);
        document.getElementById("nextBtn").disabled = (currentPage * itemsPerPage >= qrCodes.length);

        document.getElementById("pageInfo").innerHTML = `
            <span data-translate-key="28">Page</span> ${currentPage}
            <span data-translate-key="29">of</span> ${Math.ceil(qrCodes.length / itemsPerPage)}`;

        if (currentPage === 1) {
            document.getElementById("prevBtn").classList.add('dis-button');
        } else {
            document.getElementById("prevBtn").classList.remove('dis-button');
        }

        if (currentPage * itemsPerPage >= qrCodes.length) {
            document.getElementById("nextBtn").classList.add('dis-button');
        } else {
            document.getElementById("nextBtn").classList.remove('dis-button');
        }
    }

    function nextPage() {
        if (currentPage * itemsPerPage < qrCodes.length) {
            currentPage++;
            renderQRCodes();
            doTranslate('app');
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderQRCodes();
            doTranslate('app');
        }
    }

    function displayCreateModal() {
        const appDiv = document.getElementById('app');
        const modalDiv = document.createElement("div");
        modalDiv.setAttribute("id", "ce-modal-container");

        modalDiv.innerHTML = `
        <div id="ce-modal">
            <button id="close-modal-button" onclick="closeModal('ce-modal-container')">x</button>
            <h2 style="padding-top: 20px" data-translate-key="3">Create new QR Code</h2>
            <input type="text" data-translate-key="4" placeholder="Campaign Name" id="campaign-name-input"><br>
            <input type="text" list="mediums-list" data-translate-key="5" placeholder="Campaign Medium" id="campaign-medium-input" autocomplete="off"><br>
            <datalist id="mediums-list">
                <option value="Flyer" label="Flyer">
                <option value="Brochure" label="Broschüre">
                <option value="Postcard" label="Postkarte">
                <option value="Advert" label="Anzeige">
                <option value="Roll-up" label="Roll-up">
                <option value="Poster" label="Plakat">
                <option value="Merchandise" label="Werbeartikel">
            </datalist>
            <input type="text" list="lang-list" data-translate-key="6" placeholder="Language" id="language-input" autocomplete="off"><br>
            <datalist id="lang-list">
                <option value="German" label="Deutsch">
                <option value="English" label="Englisch">
            </datalist>
            <input type="text" data-translate-key="12" placeholder="Tracking URL" id="tracking-url-input"><br>
            <input type="text" data-translate-key="8" placeholder="Additional Information" id="additional-info-input"><br>
            <button id="create-button" data-translate-key="16" onclick="doCreate()">Create</button>
        </div>
        `;

        appDiv.appendChild(modalDiv);
        document.body.style.overflow = "hidden"; // Disable scrolling
        doTranslate("ce-modal-container");
    }

    function closeModal(modalId) {
        const modalDiv = document.getElementById(modalId);
        const appDiv = document.getElementById('app').removeChild(modalDiv);
        document.body.style.overflow = "auto"; // Enable scrolling
        if (modalId === "publish-modal-container") {
            history.go(0);
        }
    }

    function doCreate() {
        let campName = document.getElementById('campaign-name-input').value;
        let campMedium = document.getElementById('campaign-medium-input').value;
        let lang = document.getElementById('language-input').value;
        let trackingUrl = document.getElementById('tracking-url-input').value;
        let addInfo = document.getElementById('additional-info-input').value;

        let payload = {
            campaignName: campName,
            campaignMedium: campMedium,
            language: lang,
            trackingUrl: trackingUrl,
            additionalInfo: addInfo
        }

        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            if (this.status === 201) {
                cLog("save qr code success");
                closeModal('ce-modal-container');
                history.go(0);
            } else {
                cLog("save qr code error", this.status);
            }
        }
        xhr.open("POST", "create-qr-code", false);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(payload));
    }

    function displayConfirmPublishModal(qrid, toPublish) {
        console.log(`Publishing ${qrid} - ${toPublish}`);

        const appDiv = document.getElementById('app');
        let publishModal = document.createElement('div');
        publishModal.setAttribute("id", "publish-modal-container");

        publishModal.innerHTML = `
        <div id="ce-modal">
            <button id="close-modal-button" onclick="closeModal('publish-modal-container')">x</button>
            <h2 style="padding-top: 20px" data-translate-key="26">Please confirm publish update.</h2>
            <button id="create-button" data-translate-key="27" onclick="doPublishUpdate(${qrid}, ${toPublish})">Confirm</button>
        </div>
        `;

        appDiv.appendChild(publishModal);
        window.scrollTo(0, 0);
        document.body.style.overflow = "hidden"; // Disable scrolling
        doTranslate("publish-modal-container");
    }

    function doPublishUpdate(qrid, toPublish) {
        console.log(`Doing ${qrid} - ${toPublish}`);

        let payload = {
            qrId: qrid,
            toPublish: toPublish
        }

        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            if (this.status === 200) {
                cLog("publish update success");
                closeModal('publish-modal-container');
                history.go(0);
            } else {
                cLog("publish update error", this.status);
            }
        }
        xhr.open("POST", "publish-update", false);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(payload));
    }

    function displayEditModal(qrCodeId, campaignName, campaignMedium, language, trackingUrl, additionalInfo) {
        const appDiv = document.getElementById('app');
        const modalDiv = document.createElement("div");
        modalDiv.setAttribute("id", "edit-modal-container");

        modalDiv.innerHTML = `
        <div id="ce-modal">
            <button id="close-modal-button" onclick="closeModal('edit-modal-container')">x</button>
            <h2 style="padding-top: 20px" data-translate-key="17">Edit QR Code</h2>
            <input type="text" placeholder="${campaignName}" id="campaign-name-input"><br>
            <input type="text" list="mediums-list" placeholder="${campaignMedium}" id="campaign-medium-input" autocomplete="off"><br>
            <datalist id="mediums-list">
                <option value="Flyer" label="Flyer">
                <option value="Brochure" label="Broschüre">
                <option value="Postcard" label="Postkarte">
                <option value="Advert" label="Anzeige">
                <option value="Roll-up" label="Roll-up">
                <option value="Poster" label="Plakat">
                <option value="Merchandise" label="Werbeartikel">
            </datalist>
            <input type="text" list="lang-list" placeholder="${language}" id="language-input" autocomplete="off"><br>
            <datalist id="lang-list">
                <option value="German" label="Deutsch">
                <option value="English" label="Englisch">
            </datalist>
            <input type="text" placeholder="${trackingUrl}" id="tracking-url-input"><br>
            <input type="text" placeholder="${additionalInfo}" id="additional-info-input"><br>
            <button id="create-button" data-translate-key="18" onclick="doEdit(${qrCodeId})">Edit</button>
        </div>
        `;

        appDiv.appendChild(modalDiv);

        window.scrollTo(0, 0);
        document.body.style.overflow = "hidden"; // Disable scrolling

        doTranslate("edit-modal-container");
    }

    function doEdit(qrCodeId) {
        let campName = document.getElementById('campaign-name-input').value;
        let campMedium = document.getElementById('campaign-medium-input').value;
        let lang = document.getElementById('language-input').value;
        let trackingUrl = document.getElementById('tracking-url-input').value;
        let addInfo = document.getElementById('additional-info-input').value;

        let payload = {
            campaignName: campName,
            campaignMedium: campMedium,
            language: lang,
            trackingUrl: trackingUrl,
            additionalInfo: addInfo
        }

        console.log("edit payload: ", payload);

        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            if (this.status === 200) {
                cLog("edit qr code success");
                closeModal('edit-modal-container');
                history.go(0);
            } else {
                cLog("edit qr code error", this.status);
            }
        }
        xhr.open("PUT", "edit-qr-code/" + qrCodeId, false);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send(JSON.stringify(payload));
    }

    function displayDeleteModal(qrCodeId) {
        const appDiv = document.getElementById('app');
        let publishModal = document.createElement('div');
        publishModal.setAttribute("id", "delete-modal-container");

        publishModal.innerHTML = `
        <div id="ce-modal">
            <button id="close-modal-button" onclick="closeModal('delete-modal-container')">x</button>
            <h2 style="padding-top: 20px" data-translate-key="19">Please confirm delete.</h2>
            <button id="create-button" data-translate-key="20" onclick="doDelete(${qrCodeId})">Confirm</button>
        </div>
        `;

        appDiv.appendChild(publishModal);

        window.scrollTo(0, 0);
        document.body.style.overflow = "hidden"; // Disable scrolling

        doTranslate("delete-modal-container");
    }

    function doDelete(qrCodeId) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            if (this.status === 200) {
                cLog("delete success");
                closeModal('delete-modal-container');
                history.go(0);
            } else {
                cLog("delete error", this.status);
            }
        }
        xhr.open("DELETE", "delete/" + qrCodeId, false);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.send();
    }

    function displayDownloadModal(qrCodeId, campaignName) {
        const appDiv = document.getElementById('app');
        let publishModal = document.createElement('div');
        publishModal.setAttribute("id", "download-modal-container");

        publishModal.innerHTML = `
        <div id="ce-modal">
            <button id="close-modal-button" onclick="closeModal('download-modal-container')">x</button>
            <h2 style="padding-top: 25px" data-translate-key="21">Download QR Code</h2>
            <label data-translate-key="23">Format:</label>
            <select id="format">
                <option value="png">PNG</option>
                <option value="eps">EPS</option>
            </select><br><br>

            <label data-translate-key="24">Background Color:</label>
            <select id="color">
                <option value="black">Black</option>
                <option value="white">White</option>
                <option value="green">Green</option>
            </select><br><br>

            <label data-translate-key="25">Color Model:</label>
            <select id="model">
                <option value="rgb">RGB</option>
                <option value="cmyk">CMYK</option>
            </select><br><br>
            <button id="create-button" data-translate-key="22" onclick="doDownload('${qrCodeId}', '${campaignName}')">Download</button>
        </div>
        `;

        appDiv.appendChild(publishModal);

        window.scrollTo(0, 0);
        document.body.style.overflow = "hidden"; // Disable scrolling

        doTranslate("download-modal-container");
    }

    function doDownload(qrCodeId, campaignName) {
        let format = document.getElementById("format").value;
        let color = document.getElementById("color").value;
        let model = document.getElementById("model").value;

        console.log("Download Payload:", { qrFormat: format, qrColor: color, qrModel: model });

        var xhr = new XMLHttpRequest();
        xhr.responseType = "blob";

        xhr.onload = function () {
            if (this.status === 200) {
                console.log("Download QR Code Success");

                // Create a blob from the response
                console.log("Response for blob: ", this.response);
                let blob = new Blob([this.response], { type: xhr.getResponseHeader("Content-Type") });

                // Create a download link
                let link = document.createElement("a");
                link.href = window.URL.createObjectURL(blob);
                link.download = `qr-code-${campaignName}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                closeModal('download-modal-container');
            } else {
                console.error("Download QR Code Error", this.status);
            }
        };

        xhr.open("GET", `download-qr-code/${qrCodeId}?qrFormat=${format}&qrColor=${color}&qrModel=${model}`, true);
        xhr.send();
    }

    function getCurrentUser() {
        let appEl = document.getElementById('app');
        if (!DEV) {
            let thisUrl = "/rest/administration/users/current";
            var xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.status === 200) {
                    console.log("get current user success");
                    currentUser = JSON.parse(this.responseText);
                    console.log(currentUser);
                    lang = currentUser.language;
                    appEl.style.display = 'block';

                    // if (currentUser.roles.PIMEDIA_ORGANISATION !== "administrator") {
                    //     document.getElementById("settings_img").style.display="none";
                    // }
                } else {
                    console.log("get current user error", this.status);
                    window.location.replace(serverUrl);
                }
            }
            xhr.open("GET", thisUrl, false);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send();
        } else {
            appEl.style.display = 'block';
            currentUser = dummyUser;
        }
    }

    function doTranslate(rootElementId) {
        if (lang === "de-DE") {
            // Select every element that has data-translate-key
            let rootEl = document.getElementById(rootElementId);
            rootEl.querySelectorAll("[data-translate-key]").forEach(element => {
                const key = element.getAttribute("data-translate-key");

                // Retrieve the text from translations object
                let text = translations["de"][key];

                // If the element is an input, update the placeholder;
                // otherwise, update textContent (or innerText)
                if (element.tagName.toLowerCase() === "input") {
                    element.placeholder = text;
                } else {
                    element.textContent = text;
                }
            });
        }
    }

    // LISTEN FOR PUBLISHING EVENT
    document.addEventListener("change", function(event) {
        if (event.target.matches('.switch input[type="checkbox"]')) {
            let qrCodeContainer = event.target.closest(".qr-code-container");
            if (qrCodeContainer) {
                let qrid = qrCodeContainer.getAttribute("data-qrid");
                let isChecked = event.target.checked;
                console.log(`QR ID: ${qrid}, Published: ${isChecked ? 'true' : 'false'}`);
                displayConfirmPublishModal(qrid, isChecked ? 'true' : 'false');
            }
        }
    });

    // LISTEN FOR SEARCH EVENT
    document.addEventListener("DOMContentLoaded", function() {
        const searchInput = document.getElementById("search-input");
        searchInput.addEventListener("keyup", searchQRCodes);
    });

</script>
</body>
</html>
